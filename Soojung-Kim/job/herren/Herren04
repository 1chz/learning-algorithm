-- 고객(customer), 매출(sale), 매출상세(saledetail) 테이블이 있다.
-- 각각의 관계는
-- 고객 1:n 매출
-- 매출 1:n 매출상세

-- 1) 2019년 12월 고객별 매출 통계 (매출 높은 순으로 정렬)
SELECT
    SUB.CUSTNO,
    SUB.NAME,
    SUB.BIRTH,
    SUB.HPNO,
    SUB.SALEAMT
FROM (
	SELECT
	    A.CUSTNO,
	    A.NAME,
	    A.BIRTH,
	    A.HPNO,
	    SUM(B.SALEAMT) AS SALEAMT
	  FROM account.customer A
	  LEFT OUTER JOIN account.sale B
	    ON A.CUSTNO = B.CUSTNO
	 WHERE B.SALEDATE LIKE '201912%'
	 GROUP BY A.CUSTNO
) SUB
ORDER BY SUB.SALEAMT DESC;

-- 2) 2019년 12월 시술별 매출 통계 (매출 높은 순으로 정렬)
SELECT
	SUB.SISUL,
	SUB.SISULAMT
FROM
	(
	SELECT
		B.SISUL,
		(SUM(B.SISULAMT)) AS SISULAMT
	FROM
		account.sale A
	LEFT OUTER JOIN account.saledetail B
	  ON A.SALENO = B.SALENO
	WHERE A.SALEDATE LIKE '201912%'
	GROUP BY B.SISUL
	) SUB
ORDER BY SUB.SISULAMT DESC

-- 3) 2019년 12월 날찌별 매출 통계 (날짜 순으로 정렬)
SELECT
	SUB.SALEDATE,
	SUB.SISULAMT
FROM
	(
	SELECT
		A.SALEDATE,
		(SUM(B.SISULAMT)) AS SISULAMT
	FROM
		account.sale A
	LEFT OUTER JOIN account.saledetail B
	  ON A.SALENO = B.SALENO
	WHERE A.SALEDATE LIKE '201912%'
	GROUP BY A.SALEDATE
	) SUB
ORDER BY SUB.SALEDATE ASC

-- 4) 2019년 월별 매출 통계 (날짜 순으로 정렬)
SELECT
	SUB.SALEDATE,
	SUM(SUB.SALEAMT) AS SALEAMT
FROM
	(
	SELECT
		DATE_FORMAT(STR_TO_DATE(SALEDATE, '%Y%m'),'%Y-%m') AS SALEDATE,
		SALEAMT
	FROM
		account.sale A
	WHERE SALEDATE LIKE '2019%'
	) SUB
GROUP BY SUB.SALEDATE
ORDER BY SUB.SALEDATE ASC

-- 5) 주별 통계 (첫번째 주를 1로, 한주의 기준은 일-토요일까)
SELECT
	CONCAT(SALE_YEAR, '/', SALE_WEEK) AS YEAR_WEEK,
	SUM(SUB.SALEAMT) AS SALEAMT
FROM
	(
	SELECT
		YEAR(SALEDATE) AS SALE_YEAR,
		(WEEK(SALEDATE)+1) AS SALE_WEEK,
		SALEAMT
	FROM
		account.sale A
	) SUB
GROUP BY SUB.SALE_YEAR, SUB.SALE_WEEK
ORDER BY SUB.SALE_YEAR, SUB.SALE_WEEK ASC